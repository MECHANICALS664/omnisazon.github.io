<script>
    // ==================== CONFIGURACI√ìN ====================
    const BACKEND_URL = 'http://localhost:5000';
    
    // ==================== DEBUG ====================
    console.log('=== RESTAURANTE OMNISAZ√ìN ===');
    console.log('Frontend cargado desde:', window.location.href);
    console.log('Backend configurado en:', BACKEND_URL);
    
    // ==================== VERIFICAR CONEXI√ìN ====================
    async function verificarBackend() {
        try {
            console.log('üîç Verificando conexi√≥n al backend...');
            const response = await fetch(`${BACKEND_URL}/`);
            const data = await response.json();
            console.log('‚úÖ Backend conectado:', data.message);
            return true;
        } catch (error) {
            console.error('‚ùå Backend no disponible:', error);
            console.log('‚ö†Ô∏è Se usar√° modo local como respaldo');
            return false;
        }
    }
    
    // ==================== LOGIN MEJORADO ====================
    async function login(event) {
        event.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;
        const errorMessage = document.getElementById('errorMessage');
        
        console.log(`üîê Intentando login: ${username} / ${role}`);
        
        // Validaciones b√°sicas
        if (!role) {
            alert('‚ùå Por favor selecciona un rol');
            return;
        }
        
        if (!username || !password) {
            alert('‚ùå Usuario y contrase√±a son requeridos');
            return;
        }
        
        // Primero intentar con el backend
        const backendDisponible = await verificarBackend();
        
        if (backendDisponible) {
            console.log('üîÑ Intentando login con backend...');
            await loginConBackend(username, password, role, errorMessage);
        } else {
            console.log('üîÑ Usando login local...');
            loginLocal(username, password, role, errorMessage);
        }
    }
    
    // ==================== LOGIN CON BACKEND (PYTHON) ====================
    async function loginConBackend(username, password, role, errorMessage) {
        try {
            const response = await fetch(`${BACKEND_URL}/api/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            });
            
            const data = await response.json();
            console.log('üì® Respuesta backend:', data);
            
            if (data.success) {
                // Verificar que el rol coincida
                if (data.user.rol !== role) {
                    alert(`‚ö†Ô∏è Tu cuenta es de ${data.user.rol}\nPor favor selecciona: ${data.user.rol}`);
                    document.getElementById('role').value = data.user.rol;
                    return;
                }
                
                // Guardar informaci√≥n
                localStorage.setItem('currentUser', data.user.username);
                localStorage.setItem('userRole', data.user.rol);
                localStorage.setItem('userId', data.user.id);
                localStorage.setItem('userName', data.user.nombre);
                
                console.log('‚úÖ Login exitoso con backend');
                console.log('Usuario:', data.user);
                
                // Redirigir
                errorMessage.style.display = 'none';
                window.location.href = 'dashboard.html';
                
            } else {
                console.warn('‚ùå Backend rechaz√≥ login:', data.message);
                // Intentar con login local como respaldo
                loginLocal(username, password, role, errorMessage);
            }
            
        } catch (error) {
            console.error('üåê Error de conexi√≥n:', error);
            // Usar login local como respaldo
            loginLocal(username, password, role, errorMessage);
        }
    }
    
    // ==================== LOGIN LOCAL (RESPALDO) ====================
    function loginLocal(username, password, role, errorMessage) {
        console.log('üîÑ Usando sistema local...');
        
        // Usuarios locales de prueba
        const usuariosLocales = {
            'admin': { rol: 'admin', nombre: 'Administrador', password: '123' },
            'mesero1': { rol: 'mesero', nombre: 'Carlos L√≥pez', password: '123' },
            'mesero2': { rol: 'mesero', nombre: 'Ana Mart√≠nez', password: '123' },
            'cocinero1': { rol: 'cocinero', nombre: 'Pedro S√°nchez', password: '123' },
            'cocinero2': { rol: 'cocinero', nombre: 'Mar√≠a Gonz√°lez', password: '123' }
        };
        
        // Verificaci√≥n 1: usuario existe
        if (!usuariosLocales[username]) {
            console.warn('‚ùå Usuario no existe:', username);
            alert('‚ùå Usuario no existe\n\nUsa:\n‚Ä¢ admin\n‚Ä¢ mesero1 / mesero2\n‚Ä¢ cocinero1 / cocinero2');
            return;
        }
        
        const usuario = usuariosLocales[username];
        
        // Verificaci√≥n 2: contrase√±a correcta
        if (password !== usuario.password) {
            console.warn('‚ùå Contrase√±a incorrecta para:', username);
            alert('‚ùå Contrase√±a incorrecta');
            return;
        }
        
        // Verificaci√≥n 3: rol coincide
        if (usuario.rol !== role) {
            console.warn(`‚ùå Rol incorrecto. Usuario ${username} es ${usuario.rol}, pero seleccion√≥ ${role}`);
            alert(`‚ùå Usuario incorrecto para ese rol\n\nEl usuario "${username}" es ${usuario.rol}\nPor favor selecciona: ${usuario.rol}`);
            document.getElementById('role').value = usuario.rol;
            return;
        }
        
        // Todas las validaciones pasaron - permitir login
        // Guardar informaci√≥n
        localStorage.setItem('currentUser', username);
        localStorage.setItem('userRole', usuario.rol);
        localStorage.setItem('userId', '1');
        localStorage.setItem('userName', usuario.nombre);
        
        console.log('‚úÖ Login local exitoso:', username, 'rol:', usuario.rol);
        
        // Redirigir
        errorMessage.style.display = 'none';
        window.location.href = 'dashboard.html';
    }
    
    // ==================== INICIALIZACI√ìN ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üé¨ P√°gina de login cargada');
        
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', login);
            console.log('‚úÖ Formulario de login configurado');
        } else {
            console.error('‚ùå No se encontr√≥ el formulario');
        }
        
        // Verificar backend al cargar
        verificarBackend();
    });
</script>